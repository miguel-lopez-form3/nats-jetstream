# JetStream Self-signed TLS Setup

After a while reading and trying out different things I finally got TLS to work with `mkcert`.

I also brought the certificate generation code from the TCH RTP repo, and tried to get it working, I'll detail my findings below.

## `mkcert` Setup

I figured out that the important bit is to have both the server and client certificates generated by the same CA instead of them being self-signed, we can accomplish with the following steps:

1. Set the $CAROOT env var to the appropriate directory from the root directory of this project:

```
export CAROOT="$PWD/certs/ca"
```

2. Install the CA certificate:

```
mkcert -install
```

3. Generate the server certificates:

```
mkcert -client -cert-file ./certs/server/server.crt -key-file ./certs/server/server.key nats ::1 127.0.0.1 0.0.0.0 localhost email@localhost
```

4. Generate the client certificates:

```
mkcert -client -cert-file ./certs/client/client.crt -key-file ./certs/client/client.key nats ::1 127.0.0.1 0.0.0.0 localhost email@localhost
```

5. Bring the environment up with:

```
make up
```

6. Publish a message to the stream (it creates the streams):

```
make syncpub
```

7. Consume the message from the stream (it fetches 10 messages):

```
make pullsub
```

At the end you should see up to 10 messages as that's what `pullsub` does at the moment.

## Go Setup

I also tried creating the certificates with Go, just by using the code from the TCH RTP repo it didn't work and it keeps complaining about the handshake failing, after some reading it was clear there was a mismatch between client and server (which led me to the solution above).

I've added some code to `certs.go` to first generate a CA certificate which is then used to sign the client and server certificates, but it keeps complaining about `Form3` not being a valid certificate authority (paraphrasing here).

You can delete the certs with `make clean` and run `make certs` which should generate the CA, client and server certs in the same place as the `mkcert` setup and run the same tests as before.